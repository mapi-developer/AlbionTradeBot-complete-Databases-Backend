steps:
  # =====================================================
  # STEP 1: TEST
  # =====================================================
  - name: 'python:3.13-slim'
    id: 'run-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Installing dependencies..."
        pip install --no-cache-dir -r requirements.txt
        pip install pytest httpx
        
        echo "Running tests..."
        export TRADE_BOT_DB_URL="sqlite+aiosqlite:///:memory:"
        export CRYPTO_BACKEND_DB_URL="sqlite+aiosqlite:///:memory:"
        pytest

  # =====================================================
  # STEP 2: BUILD
  # =====================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args: [
      'build', 
      '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_IMAGE_NAME:$COMMIT_SHA', 
      '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_IMAGE_NAME:latest',
      '.'
    ]

  # =====================================================
  # STEP 3: PUSH
  # =====================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args: [
      'push', 
      '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_IMAGE_NAME:$COMMIT_SHA'
    ]

  # =====================================================
  # STEP 4: DATABASE RESET & RECREATION
  # =====================================================
  - name: '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_IMAGE_NAME:$COMMIT_SHA'
    id: 'reset-and-recreate-db'
    entrypoint: 'bash'
    secretEnv: ['DB_PASSWORD']
    args:
      - '-c'
      - |
        echo "Waiting for Cloud SQL Proxy..."
        sleep 5
        
        # Inject necessary environment variables for database.py to build the URL
        export DB_USER=$_DB_USER
        export DB_PASSWORD=$$DB_PASSWORD
        export INSTANCE_CONNECTION_NAME="localhost" # Proxy is local to this container
        
        echo "Wiping and recreating tables for all databases..."
        python3 reset_db.py
        
        # Optional: Uncomment if you decide to use Alembic later
        # echo "Running Alembic migrations..."
        # python3 -m alembic upgrade head
    services:
      - name: 'gcr.io/cloudsql-docker/gce-proxy:latest'
        args:
          - '/cloud_sql_proxy'
          - '-instances=$_DB_INSTANCE_CONNECTION_NAME=tcp:5432'

  # =====================================================
  # STEP 5: DEPLOY
  # =====================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-cloud-run'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '$_SERVICE_NAME'
      - '--image'
      - '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_IMAGE_NAME:$COMMIT_SHA'
      - '--region'
      - '$_REGION'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--add-cloudsql-instances'
      - '$_DB_INSTANCE_CONNECTION_NAME'
      - '--set-secrets'
      - 'DB_PASSWORD=DB_PASSWORD:latest'
      - '--set-secrets'
      - 'NOWPAYMENTS_API_KEY=NOWPAYMENTS_API_KEY:latest'
      - '--set-secrets'
      - 'NOWPAYMENTS_IPN_SECRET=NOWPAYMENTS_IPN_SECRET:latest'
      - '--set-env-vars'
      - 'DB_USER=$_DB_USER'
      - '--set-env-vars'
      - 'INSTANCE_CONNECTION_NAME=$_DB_INSTANCE_CONNECTION_NAME'
      - '--set-env-vars'
      - 'DB_NAME_TRADE=trade_bot_db'
      - '--set-env-vars'
      - 'DB_NAME_CRYPTO=crypto_backend_db'

# =====================================================
# SECRETS & VARIABLES
# =====================================================
availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/DB_PASSWORD/versions/latest
    env: 'DB_PASSWORD'

substitutions:
  _REGION: 'europe-west4'
  _REPO_NAME: 'app-repo'
  _IMAGE_NAME: 'trade-backend'
  _SERVICE_NAME: 'trade-backend-service'
  _DB_INSTANCE_CONNECTION_NAME: 'albiontradebot-backend:europe-west4:albion-trade-bot-db'
  _DB_USER: 'postgres' 

options:
  logging: CLOUD_LOGGING_ONLY
images:
  - '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_IMAGE_NAME:latest'